<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>SGLoveLah - Chats</title>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script><script  src="/esdproject/js/chat.js"></script>

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'>
	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/3.0.1/iconfont/material-icons.min.css'>
	<link rel="stylesheet" href="/esdproject/css/chat.css">
	<link rel="stylesheet" href="/esdproject/css/bootstrap.css" type='text/css'>

	<style>
		.live_chat {
		height:500px;
		overflow-y: scroll;
		}
	</style>


</head>
<body>
<header>
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
		<a class="navbar-brand" href="#">SGLoveLah</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
			<ul class="navbar-nav">
				<li class="nav-item active">
				<a class="nav-link" href="/esdproject/frontend/Discover.php">Discover</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/esdproject/frontend/Matches.php">Matches</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" href="chat.html">Chat</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="account.html">Account</a>
				</li>
			</ul>
		</div>
	</nav>
</header>
<section class="py-5">
    <div class="container">
        <h3 class="text-uppercase font-weight-light text-center m-5">User Chats</h3>
    </div>

	<div class="container">
        <div class="row no-gutters">
            <div class="col-md-4 border-right">
                <div class="settings-tray">
                  <img class="profile-image" src="/esdproject/img/profile.jpg" alt="Profile img">
                  <span class="settings-tray--right">
                    <i class="material-icons">cached</i>
                    <i class="material-icons">message</i>
                    <i class="material-icons">menu</i>
                  </span>
                </div>
                <div class="search-box">
                  <div class="input-wrapper">
                    <i class="material-icons">search</i>
                    <input placeholder="Search here" type="text">
                  </div>
                </div>
                <div class="friend-drawer friend-drawer--onhover">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/robocop.jpg" alt="">
                  <div class="text">
                    <h6>Robo Cop</h6>
                    <p class="text-muted">Hey, you're arrested!</p>
                  </div>
                  <span class="time text-muted small">13:21</span>
                </div>
                <hr>
                <div class="friend-drawer friend-drawer--onhover">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/optimus-prime.jpeg" alt="">
                  <div class="text">
                    <h6>Optimus</h6>
                    <p class="text-muted">Wanna grab a beer?</p>
                  </div>
                  <span class="time text-muted small">00:32</span>
                </div>
                <hr>
                <div class="friend-drawer friend-drawer--onhover ">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/real-terminator.png" alt="">
                  <div class="text">
                    <h6>Skynet</h6>
                    <p class="text-muted">Seen that canned piece of s?</p>
                  </div>
                  <span class="time text-muted small">13:21</span>
                </div>
                <hr>
                <div class="friend-drawer friend-drawer--onhover">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/termy.jpg" alt="">
                  <div class="text">
                    <h6>Termy</h6>
                    <p class="text-muted">Im studying spanish...</p>
                  </div>
                  <span class="time text-muted small">13:21</span>
                </div>
                <hr>
                <div class="friend-drawer friend-drawer--onhover">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/rick.jpg" alt="">
                  <div class="text">
                    <h6>Richard</h6>
                    <p class="text-muted">I'm not sure...</p>
                  </div>
                  <span class="time text-muted small">13:21</span>
                </div>
                <hr>
                <div class="friend-drawer friend-drawer--onhover">
                  <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/rachel.jpeg" alt="">
                  <div class="text">
                    <h6>Alice</h6>
                    <p class="text-muted">Hey, I have something for you!</p>
                  </div>
                  <span class="time text-muted small">13:21</span>
                </div>
			</div>

			<div class="col-md-8">
                <div class="settings-tray">
                    <div class="friend-drawer no-gutters friend-drawer--grey">
                    <img class="profile-image" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/robocop.jpg" alt="">
                    <div class="text">
                      <h6>Robo Cop</h6>
                      <p class="text-muted">Layin' down the law since like before Christ...</p>
                    </div>
                    <span class="settings-tray--right">
                      <i class="material-icons">cached</i>
                      <i class="material-icons">message</i>
                      <i class="material-icons">menu</i>
                    </span>
                  </div>
                </div>
                <div class="chat-panel">
				<ul class = 'live_chat' id="messages"></ul>
                  <div class="row">
                    <div class="col-12">
                      <div class="chat-box-tray">
                        <i class="material-icons">sentiment_very_satisfied</i>
                        
						<div class="p-3 mb-2 col-xl-12 text-white">
						<input type="text" id="myMessage">
						<button id="sendbutton"><i class="material-icons">send</i></button>
						</div>
                        
                      </div>
                    </div>
                  </div>
                </div>
			  </div>
			  
		</div>
	</div>

<script type="text/javascript">
// hardcoded user & IP for now
var user = 'John'
var IP = 'http://127.0.0.1:5002'
$(document).ready(function() {
	
    // if(IP == 'http://127.0.0.1:5001'){
    //     msg = 'johnybaby'
    //     $("#messages").append('<li>'+msg+'</li>');
    // }else{
    //     msg = 'Steven'
    //     $("#messages").append('<li>'+msg+'</li>');
    // }
    //connect to IP must be retrieve from database
	var socket = io.connect(IP);

	socket.on('connect', function() {
		
		// socket.send(chatlogs);
		console.log('hello')
		$(async()=>{
			var SERVICEURL = 'http://127.0.0.1:5000/postchathistory';

			// console.log(isbnNumber)
			console.log(SERVICEURL)

			try{

			const response = 
					await fetch(
						SERVICEURL, {method: 'GET'}
					);
			if(!response.ok){
				console.log('fail');
			}else{
				const data = await response.json();
				var chatlogs = data.chathistory;
				console.log(chatlogs);
				chatlogs.forEach(function(item,index){
					socket.send('('+item.created_on+') '+ user + ': ' + item.msg)
				});
			}
			}catch(error){
                console.log('error')
        	}   
			socket.send("<b>" + user + ' has connected!' + "</b>");
		})

		
	});

    socket.on('disconnect', function() {
		socket.send(user + ' has diconnected!');
	});

	socket.on('message', function(msg) {
		$("#messages").append('<li>'+msg+'</li>');
	});

	$('#sendbutton').on('click', function() {
		event.preventDefault();
		console.log('test');
		$(async ()=>{
			var messagetosend =  $('#myMessage').val();
			console.log(messagetosend);
			var testvariable = 'sendmessageover';
			console.log(testvariable);

			var updateURL = 'http://127.0.0.1:5000/updatechatlogs';
			console.log(updateURL);
			try{
				const response = 
				await fetch(
							updateURL, {
							method: 'POST',
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ messagetosend: messagetosend, userID: 3, matchID: 5 })
							});
				if(!response.ok){
					console.log('fail');
				}else{
					console.log('success');
				}    
			}catch(error){
			console.log('error')
			}

			socket.send(user +': '+ $('#myMessage').val());

			$('#myMessage').val('');
		})
		
	});

});
</script>
<!-- <ul id="messages"></ul>
<div class="p-3 mb-2 bg-primary text-white">
<input type="text" id="myMessage">
<button id="sendbutton">Send</button>
</div> -->
</body>


</html>