<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>SGLoveLah - Chats</title>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script><script  src="/esdproject/js/chat.js"></script>

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'>
	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/3.0.1/iconfont/material-icons.min.css'>
	<link rel="stylesheet" href="../../css/chat.css">
	<link rel="stylesheet" href="../../css/bootstrap.css" type='text/css'>

	<style>
		.live_chat {
		height:500px;
		overflow-y: scroll;
		}
	</style>


</head>
<body>
<header>
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
		<a class="navbar-brand" href="#">SGLoveLah</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
			<ul class="navbar-nav">
				<li class="nav-item active">
				<a class="nav-link" href="/esdproject/frontend/Discover.php">Discover</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/esdproject/frontend/Matches.php">Matches</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" href="chat.html">Chat</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="account.html">Account</a>
				</li>
			</ul>
		</div>
	</nav>
</header>
<section class="py-5">
    <div class="container">
				<!-- text-center -->
        <h3 class="text-uppercase font-weight-light  m-5">Personal Chats</h3>
    </div>

	<div class="container">
        <div class="row no-gutters">
			<div class="col-md-8">
                <div class="settings-tray">
                    <div class="friend-drawer no-gutters friend-drawer--grey">
                    <img class="profile-image" id="changevariable" src="https://clarity-enhanced.net/wp-content/themes/clarity-enhanced/assets/img/bootstrap-chat-app-assets/robocop.jpg" alt="">
                    <div class="text">
					  <h6 id="dynamicname">Robo Cop</h6>
					  
                      <!-- <p class="text-muted">Layin' down the law since like before Christ...</p> -->
                    </div>
                    <span class="settings-tray--right">
						<button id="readyBtn" type="button" class="btn btn-success">Ready</button>
                      <i class="material-icons">cached</i>
                      <i class="material-icons">message</i>
					  <!-- <i class="material-icons">menu</i> -->
					  
                    </span>
                  </div>
                </div>
                <div class="chat-panel">
				<ul class = 'live_chat' id="messages"></ul>
                  <div class="row">
                    <div class="col-12">
                      <div class="chat-box-tray">
                        <i class="material-icons">sentiment_very_satisfied</i>
                        
						<div class="p-3 mb-2 col-xl-12 text-white">
						<input type="text" id="myMessage">
						<button id="sendbutton"><i class="material-icons">send</i></button>
						</div>
                        
                      </div>
                    </div>
                  </div>
                </div>
			  </div>
			  
		</div>
	</div>

<script type="text/javascript">
// hardcoded user & IP for now


$(document).ready(function() {
		$(async()=>{
			console.log('here');
			//CODE SESSION HERE//
			var matchID = sessionStorage.getItem("matchID");
			//
			var otheruserID = sessionStorage.getItem("otheruserID");
			otherimageURL = "http://127.0.0.1:3000/getimage/"+otheruserID;

			checkreadyURL = "http://127.0.0.1:7007/checkreadystatus/"+matchID;
			
			matchedURL = "http://127.0.0.1:2000/profile/" + otheruserID;
			// console.log(matchedURL);
			const matchedprofiles =
			await fetch(
			matchedURL, { method: 'GET' }
			);
			var matchedprofile = await matchedprofiles.json();
			// console.log(matchedprofile);
			var currentname = matchedprofile.name;
			console.log(currentname);
			document.getElementById("dynamicname").innerHTML = currentname;

			const readyresult = 
			await fetch(
			checkreadyURL, {method: 'GET'}
			);
			var checkreadystatus = await readyresult.json();
			

			if(checkreadystatus.message == "success"){
				document.getElementById("changevariable").src = otherimageURL;
			}else{
				document.getElementById("changevariable").style.filter = "blur(8px)";
				document.getElementById("changevariable").src = otherimageURL;
			}
			
			var userID = sessionStorage.getItem("accountID");
			getnameURL = "http://127.0.0.1:2000/profile/"+userID;
			const userIDname =
			await fetch(
				getnameURL, { method: 'GET' }
			);
			var username = await userIDname.json();
			var user = username.name;

			
			getchatURL = "http://127.0.0.1:5009/getchataddress/"+matchID;

			const chatroomIP =
			await fetch(
				getchatURL, { method: 'GET' }
			);
			var chatI = await chatroomIP.json();
			var chatIP = chatI.chatserver;

		
	var socket = io.connect(chatIP);

	socket.on('connect', function() {
		
		// socket.send(chatlogs);
		console.log('hello')
		$(async()=>{
			var SERVICEURL = 'http://127.0.0.1:5009/postchathistory/'+matchID ;

			// console.log(isbnNumber)
			console.log(SERVICEURL)

			try{

			const response = 
					await fetch(
						SERVICEURL, {method: 'GET'}
					);
			if(!response.ok){
				console.log('fail');
			}else{
				const data = await response.json();
				var chatlogs = data.chathistory;
				console.log(chatlogs);
				chatlogs.forEach(function(item,index){
					$(async()=>{
							var tempuserid = item.userID

							getnameURL = "http://127.0.0.1:2000/profile/"+tempuserid;
							const userIDname =
							await fetch(
								getnameURL, { method: 'GET' }
							);
							var usern = await userIDname.json();
							var tempuser = usern.name;

							socket.send('('+item.created_on+') '+ tempuser + ': ' + item.msg)
						});
				});
			}
			}catch(error){
                console.log('error')
        	}   
			socket.send("<b>" + user + ' has connected!' + "</b>");
		})

		
	});

    socket.on('disconnect', function() {
		socket.send(user + ' has diconnected!');
	});

	socket.on('message', function(msg) {
		$("#messages").append('<li>'+msg+'</li>');
	});

	$('#sendbutton').on('click', function() {
		event.preventDefault();
		console.log('test');
		$(async ()=>{
			var messagetosend =  $('#myMessage').val();
			console.log(messagetosend);
			var testvariable = 'sendmessageover';
			console.log(testvariable);
			var matchID = sessionStorage.getItem("matchID");
			var updateURL = 'http://127.0.0.1:5009/updatechatlogs';
			console.log(updateURL);
			try{
				const response = 
				await fetch(
							updateURL, {
							method: 'POST',
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ messagetosend: messagetosend, userID: userID, matchID: matchID })
							});
				if(!response.ok){
					console.log('fail');
				}else{
					console.log('success');
				}    
			}catch(error){
			console.log('error')
			}

			socket.send(user +': '+ $('#myMessage').val());

			$('#myMessage').val('');
		})
		
	});

	})
});
</script>
<!-- <ul id="messages"></ul>
<div class="p-3 mb-2 bg-primary text-white">
<input type="text" id="myMessage">
<button id="sendbutton">Send</button>
</div> -->

<script>
	
	
	// Action Listener
	$("#readyBtn").click(function(event){
				alert("hi");
				event.preventDefault(); // event - allows console logs to be displayed (solves refresh problem)
				console.log(event);
				var matchID = sessionStorage.getItem("matchID");
				var userID = sessionStorage.getItem("accountID");;
				console.log('test');
				console.log(matchID);
				// var profileID = sessionStorage.getItem("accountID");
			    var serviceURL = "http://127.0.0.1:7007/ready/"+matchID+"/"+userID;

			    var requestBody = {
			        
			    };

			    putData(serviceURL, requestBody);
				$('#error').remove();

				var readyURL = "http://127.0.0.1:7007/checkreadystatus/"+matchID;
				const readystatus =
					await fetch(
					readyURL, { method: 'GET' }
					);
					var readiness = await readystatus.json();
					// console.log(matchedprofile);
					if(readiness.message == "success"){
						document.getElementById("changevariable").style.filter = "blur(0px)";
						// window.location.href = "privatechat.html";
					}
			});

			async function putData(serviceURL, requestBody){
				// console.log(requestBody);
			    var requestParam = {
			        headers: { "content-type": "application/json;" },
			        mode: 'cors', // other options: no-cors, navigate, same-origin
			        method: 'PUT',
			        body: JSON.stringify(requestBody)
			    }
				
			    try {
			        const response = await fetch(serviceURL, requestParam);
					console.log(response);
					
					// data = await response.json();
			//         console.log(data);
					// var isbnNumber = $('#isbn13').val();
				if(response.ok){
					alert('you have readied up');
					// window.location.href = "account.html";
		
						
				}
				else{
					// alert('Profile Information Failed to update!');
				}
			    } catch (error) {

			        console.error(error);
			    }
			}
</script>
</body>


</html>